---
title: "MigForecastModels_TargetStoch"
output: html_document
date: ""
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



# Setup
```{r, include=FALSE}
library(pacman)
pacman::p_load(tidyverse, lubridate, data.table, tictoc, countrycode,
               ggplot2, scales, geomtextpath, foreach, ggpp,
               caret, doParallel, randomForest,
               yuima, xts, corrplot, ggdendro, cowplot,dendextend,
               ggpubr
               )

```



# Preprocessing Training data
Note: If change vars here, re-run llag analysis below
```{r, echo=F, message=F, warning=F}
testing.periods <- 6

#-- load data
df <- fread("cleaned.Mast.df.csv") %>% as.data.frame()
df$destination <- countrycode(df$destination, origin = "country.name", destination = "iso3c")

#-- create year month
df$year.mon <- as.Date(as.yearmon(sprintf("%s/%s",df$month,df$year), "%m/%Y"), frac=1.)
df <- df %>% subset(., select = -c(year, month))

# -- Select vars
temp <- df %>%
    dplyr::select(destination, year.mon)

##################################################################
  # drought
temp <- df %>%
    dplyr::select(destination, year.mon,
      matches("(%)") & !ends_with(".obs"),
                  )%>%
  gather(var, value, -c(destination, year.mon)) %>%
  filter(grepl(".3", var)) %>%
  mutate(value=as.numeric(value)) %>% spread(var,value)

     ## preprocess
pp.mod <- preProcess(temp[,3:ncol(temp)], method = c("nzv"))
temp <- predict(pp.mod, newdata = temp)

temp <- temp %>% gather(var,value,-c(destination, year.mon)) %>%
  arrange(destination,var,year.mon) %>% 
  group_by(destination,var) %>%
  dplyr::mutate(value=value-first(value),
                value=log(value-min(value)+0.0001),
                # value=value-dplyr::lag(value,1,default=first(value),order_by=year.mon)
                )

temp <- temp %>% 
  arrange(destination,var,year.mon) %>% 
  group_by(destination,var) %>%
  dplyr::mutate(
    cum.m=cummean(value),
    v=value-cum.m
    ) %>% dplyr::select(-value)
temp <- pivot_wider(data = temp,
            id_cols = c(destination, year.mon),
            names_from = var,
            values_from = c("cum.m", "v"))

pp.mod <- preProcess(temp[,3:ncol(temp)], method = c("nzv"))
temp <- predict(pp.mod, newdata = temp)

      ### plot
plot.df <- temp %>% gather(var,value,-c(destination, year.mon)) %>%
  mutate(event=word(var,2,2,sep="-"),loc=word(var,1,1,sep="-"),
         var.type=word(var,1,1,sep="_"))
ggplot(plot.df, aes(x=year.mon, y=value, color=loc) ) +
  geom_line(show.legend = F)+
  facet_wrap(event~var.type,  ncol=2)+
  theme_minimal() +
  scale_x_date(labels = date_format("%Y-%m"))

sharp.var <- temp

###################################################################
  # gdelt
temp.mean <- df %>%
  dplyr::select(destination, year.mon, starts_with("gdelt") & ends_with("-mean")) %>%
  gather(var, mean, -c(destination, year.mon)) %>%
  mutate(var=gsub("-mean","", var))
temp <- temp.mean %>%
  mutate(value=mean) %>%
  subset(., select = -c(mean)) 
temp <- temp %>% spread(var,value)

    ## preprocess 
pp.mod <- preProcess(temp[,3:ncol(temp)], method = c("nzv"))
temp <- predict(pp.mod, newdata = temp)

temp <- temp %>% gather(var,value,-c(destination, year.mon)) %>%
  arrange(destination,var,year.mon) %>% 
  group_by(destination,var) %>%
  dplyr::mutate(value=value-first(value),
                value=log(value-min(value)+0.0001),
                # value=value-dplyr::lag(value,1,default=first(value),order_by=year.mon)
                )

temp <- temp %>% 
  arrange(destination,var,year.mon) %>% 
  group_by(destination,var) %>%
  dplyr::mutate(
    cum.m=cummean(value),
    v=value-cum.m
    ) %>% dplyr::select(-value)
temp <- pivot_wider(data = temp,
            id_cols = c(destination, year.mon),
            names_from = var,
            values_from = c("cum.m", "v"))

pp.mod <- preProcess(temp[,3:ncol(temp)], method = c("nzv"))
temp <- predict(pp.mod, newdata = temp)

      ### plot
plot.df <- temp %>% gather(var,value,-c(destination, year.mon)) %>%
  mutate(event=word(var,3,3,sep="-"),loc=word(var,2,2,sep="-"),
         var.type=word(var,1,1,sep="_"))
ggplot(plot.df, aes(x=year.mon, y=value, color=loc) ) +
  geom_line(show.legend = F)+
  facet_wrap(event~var.type, scales = "free_y", ncol=2)+
  theme_minimal() +
  scale_x_date(labels = date_format("%Y-%m"))
ggsave(paste(getwd(), "/output/", "temp.jpeg", sep=""),height=10 )

# save
sharp.var <- left_join(sharp.var, temp)

###################################################################
  # SPEI
temp.mean <- df %>%
  dplyr::select(destination, year.mon, matches("SPEI.mean")) %>%
  gather(var, mean, -c(destination, year.mon)) %>%
  mutate(var=gsub(".mean","", var))
temp <- temp.mean %>%
  mutate(value=mean) %>%
  subset(., select = -c(mean))
temp <- temp %>% spread(var,value)

 ## preprocess 
pp.mod <- preProcess(temp[,3:ncol(temp)], method = c("nzv"))
temp <- predict(pp.mod, newdata = temp)

temp <- temp %>% gather(var,value,-c(destination, year.mon)) %>%
  arrange(destination,var,year.mon) %>% 
  group_by(destination,var) %>%
  dplyr::mutate(value=value-first(value),
                value=log(value-min(value)+0.0001),
                # value=value-dplyr::lag(value,1,default=first(value),order_by=year.mon)
                )

temp <- temp %>% 
  arrange(destination,var,year.mon) %>% 
  group_by(destination,var) %>%
  dplyr::mutate(
    cum.m=cummean(value),
    v=value-cum.m
    ) %>% dplyr::select(-value)
temp <- pivot_wider(data = temp,
            id_cols = c(destination, year.mon),
            names_from = var,
            values_from = c("cum.m", "v"))

pp.mod <- preProcess(temp[,3:ncol(temp)], method = c("nzv"))
temp <- predict(pp.mod, newdata = temp)

      ### plot
plot.df <- temp %>% gather(var,value,-c(destination, year.mon)) %>%
  mutate(event=word(var,2,2,sep="-"),loc=word(var,1,1,sep="-"),
         var.type=word(var,1,1,sep="_"))
ggplot(plot.df, aes(x=year.mon, y=value, color=loc) ) +
  geom_line(show.legend = F)+
  facet_wrap(event~var.type, scales = "free_y", ncol=2)+
  theme_minimal() +
  scale_x_date(labels = date_format("%Y-%m"))

  # save
sharp.var <- left_join(sharp.var, temp)

###################################################################
  # SAVI
temp.mean <- df %>%
  dplyr::select(destination, year.mon, matches("SAVI_mean")) %>%
  gather(var, mean, -c(destination, year.mon)) %>%
  mutate(var=gsub("_mean","", var))
temp <- temp.mean %>%
  mutate(value=mean) %>%
  subset(., select = -c(mean))
temp <- temp %>% spread(var,value)

## preprocess 
pp.mod <- preProcess(temp[,3:ncol(temp)], method = c("nzv"))
temp <- predict(pp.mod, newdata = temp)

temp <- temp %>% gather(var,value,-c(destination, year.mon)) %>%
  arrange(destination,var,year.mon) %>% 
  group_by(destination,var) %>%
  dplyr::mutate(value=value-first(value),
                value=log(value-min(value)+0.0001),
                # value=value-dplyr::lag(value,1,default=first(value),order_by=year.mon)
                )

temp <- temp %>% 
  arrange(destination,var,year.mon) %>% 
  group_by(destination,var) %>%
  dplyr::mutate(
    cum.m=cummean(value),
    v=value-cum.m
    ) %>% dplyr::select(-value)
temp <- pivot_wider(data = temp,
            id_cols = c(destination, year.mon),
            names_from = var,
            values_from = c("cum.m", "v"))

pp.mod <- preProcess(temp[,3:ncol(temp)], method = c("nzv"))
temp <- predict(pp.mod, newdata = temp)

      ### plot
plot.df <- temp %>% gather(var,value,-c(destination, year.mon)) %>%
  mutate(event=word(var,2,2,sep="-"),loc=word(var,1,1,sep="-"),
         var.type=word(var,1,1,sep="_"))
ggplot(plot.df, aes(x=year.mon, y=value, color=loc) ) +
  geom_line(show.legend = F)+
  facet_wrap(event~var.type, ncol=2)+
  theme_minimal() +
  scale_x_date(labels = date_format("%Y-%m"))
ggsave(paste(getwd(), "/output/", "savi.jpeg", sep="") )

  # save
sharp.var <- left_join(sharp.var, temp)

###################################################################
  # Soil moisture
temp.mean <- df %>%
  dplyr::select(destination, year.mon, matches("Soil moisture index.mean")) %>%
  gather(var, mean, -c(destination, year.mon)) %>%
  mutate(var=gsub(".mean","", var))
temp <- temp.mean %>%
  mutate(value=mean/100) %>%
  subset(., select = -c(mean))
temp <- temp %>% spread(var,value)

## preprocess 
pp.mod <- preProcess(temp[,3:ncol(temp)], method = c("nzv"))
temp <- predict(pp.mod, newdata = temp)

temp <- temp %>% gather(var,value,-c(destination, year.mon)) %>%
  arrange(destination,var,year.mon) %>% 
  group_by(destination,var) %>%
  dplyr::mutate(value=value-first(value),
                value=log(value-min(value)+0.0001),
                # value=value-dplyr::lag(value,1,default=first(value),order_by=year.mon)
                )

temp <- temp %>% 
  arrange(destination,var,year.mon) %>% 
  group_by(destination,var) %>%
  dplyr::mutate(
    cum.m=cummean(value),
    v=value-cum.m
    ) %>% dplyr::select(-value)
temp <- pivot_wider(data = temp,
            id_cols = c(destination, year.mon),
            names_from = var,
            values_from = c("cum.m", "v"))

pp.mod <- preProcess(temp[,3:ncol(temp)], method = c("nzv"))
temp <- predict(pp.mod, newdata = temp)

      ### plot
plot.df <- temp %>% gather(var,value,-c(destination, year.mon)) %>%
  mutate(event=word(var,2,2,sep="-"),loc=word(var,1,1,sep="-"),
         var.type=word(var,1,1,sep="_"))
ggplot(plot.df, aes(x=year.mon, y=value, color=loc) ) +
  geom_line(show.legend = F)+
  facet_wrap(event~var.type, scales = "free_y", ncol=2)+
  theme_minimal() +
  scale_x_date(labels = date_format("%Y-%m"))

  # save
sharp.var <- left_join(sharp.var, temp)

###################################################################
  # Twitter hate
temp.mean <- df %>%
  dplyr::select(destination, year.mon,
                starts_with("twitter-hate") & ends_with("mean")) %>%
  gather(var, mean, -c(destination, year.mon)) %>%
  mutate(var=gsub("-mean","", var))
temp <- temp.mean %>%
  mutate(value=mean) %>%
  subset(., select = -c(mean))
temp <- temp %>% spread(var, value)

    ## preprocess
pp.mod <- preProcess(temp, method = c("nzv"))
temp <- predict(pp.mod, newdata = temp)

temp <- temp %>% gather(var,value,-c(destination, year.mon)) %>%
  arrange(destination,var,year.mon) %>% 
  group_by(destination,var) %>%
  dplyr::mutate(value=value-first(value),
                value=log(value-min(value)+0.0001),
                # value=value-dplyr::lag(value,1,default=first(value),order_by=year.mon)
                )

temp <- pivot_wider(data = temp,
            id_cols = c(destination, year.mon),
            names_from = var,
            values_from = c("value"))

pp.mod <- preProcess(temp, method = c("nzv"))
temp <- predict(pp.mod, newdata = temp)

      ### plot
plot.df <- temp %>% gather(var,value,-c(destination, year.mon))
ggplot(plot.df, aes(x=year.mon, y=value, color=destination) ) +
  geom_line(show.legend = F)+
  facet_wrap(.~var, scales = "free_y", ncol=2)+
  theme_minimal() +
  scale_x_date(labels = date_format("%Y-%m"))

  # save
sharp.var <- left_join(sharp.var, temp)

###################################################################
  # Twitter sent
temp.mean <- df %>%
  dplyr::select(destination, year.mon,
                starts_with("twitter-sentiment") & ends_with("mean")) %>%
  gather(var, mean, -c(destination, year.mon)) %>%
  mutate(var=gsub("-mean","", var))
temp <- temp.mean %>%
  mutate(value=mean) %>%
  subset(., select = -c(mean))
temp <- temp %>% spread(var, value)

    ## preprocess
pp.mod <- preProcess(temp, method = c("center","scale","nzv"))
temp <- predict(pp.mod, newdata = temp)

temp <- temp %>% gather(var,value,-c(destination, year.mon)) %>%
  arrange(destination,var,year.mon) %>% 
  group_by(destination,var) %>%
  dplyr::mutate(value=value-first(value),
                value=log(value-min(value)+0.0001),
                # value=value-dplyr::lag(value,1,default=first(value),order_by=year.mon)
                )

temp <- pivot_wider(data = temp,
            id_cols = c(destination, year.mon),
            names_from = var,
            values_from = c("value"))

pp.mod <- preProcess(temp, method = c("nzv"))
temp <- predict(pp.mod, newdata = temp)

      ### plot
plot.df <- temp %>% gather(var,value,-c(destination, year.mon))
ggplot(plot.df, aes(x=year.mon, y=value, color=destination) ) +
  geom_line(show.legend = F)+
  facet_wrap(.~var, scales = "free_y", ncol=2)+
  theme_minimal() +
  scale_x_date(labels = date_format("%Y-%m"))

  # save
sharp.var <- left_join(sharp.var, temp)

###################################################################
temp <- df %>% dplyr::select(destination, year.mon, asr) %>% 
  mutate(asr=log(asr),
         destination=paste("spill","_",destination,sep="")) %>% 
  spread(destination,asr)

  # save
sharp.var <- left_join(sharp.var, temp)

###################################################################

#-- df.x
df.x <- sharp.var
temp <- df.x$year.mon |> unique()|> sort()
cutoff.time <- temp[length(temp)-testing.periods]

df.x.train <- df.x %>% 
  filter(year.mon<=cutoff.time)

#-- df.y
temp <- df %>% arrange(destination,year.mon) %>% group_by(destination) %>% 
  dplyr::mutate(y=log(asr) ) %>%
  dplyr::select(destination, year.mon, y)

df.y <- temp 

  ## df.y.ma
ma.period <- 1
df.y.ma <- df.y %>% group_by(destination) %>%
    dplyr::mutate(y=
             zoo::rollapply(y, ma.period, mean,
                            align='center',partial=T, order_by=year.mon)) %>%
  drop_na()

      ### plot
ggplot(df.y.ma, aes(x=year.mon, y=y) ) +
  geom_line()+
  geom_point(data=df.y, aes(x=year.mon, y=y), shape=1)+
  facet_wrap(.~destination, scales = "free_y", ncol=4)+
  theme_minimal() +
  scale_x_date(labels = date_format("%Y-%m")) +
  ylab("Asyl. Seekers")
ggsave(paste(getwd(), "/output/", "som_eu_ma.jpeg", sep="") )

#-- select top countries 
top.dest <- df.y %>% group_by(destination) %>% 
  dplyr::summarise(m=mean(y)) %>% 
  slice_max(., n=8, order_by=m) 
top.dest <- top.dest$destination

#-- select countries to be included in the analysis
# dest.name <- top.dest[1:7]
dest.name <- df.x$destination %>% unique()

dim(df.x)

```



# Descriptive ASR trends
```{r}
#-- plot y
temp <- df.y %>%
  group_by(destination) %>%
  mutate(y=exp(y)*1000,
         d.alpha=mean(y, na.rm=T))

ggplot(temp, aes(x=year.mon, y=y) ) +
  geom_textline(data=filter(temp, destination %in% top.dest),
                aes(label=destination, color=destination, #alpha=d.alpha
                    ),
                show.legend=F,  vjust=.0, hjust="ymid", text_smoothing=30,
                ) + 
  geom_line(data=filter(temp, !destination %in% top.dest),
                aes(group=destination),color="grey80")+
  geom_vline(xintercept=temp$year.mon[nrow(temp)-testing.periods], color="grey") +
  theme_minimal() +
  scale_fill_brewer(palette = "Dark2") +
  scale_x_date(labels = date_format("%Y-%m")) +
  ylab("Asyl. Seekers per 1000 Origin Pop.") + xlab("Month") 
ggsave(paste(getwd(), "/output/", "som_eu.jpeg", sep="") )

#-- plot x
temp <- df.x %>% ungroup %>%  select(-destination) %>% distinct() %>% 
  gather(key,value,-c(year.mon)) %>% 
  filter(!grepl("spill",key)) %>% 
  mutate(type=word(key,1,1,sep="_"),
         res=word(key,2,2,sep="_"),
         loc=ifelse(grepl("gdelt",res), 
                    word(res,2,2,sep="-"),
                    word(res,1,1,sep="-")),
         what=ifelse(grepl("gdelt",res),
                     paste("GDT:",word(res,3,3,sep="-")),
                     word(res,2,2,sep="-")),
         )


ggplot(temp, aes(x=year.mon, y=value) ) +
  geom_line(data=temp, aes(color=loc), alpha=0.38, size=.5,
            show.legend=F)+
  geom_line(data=temp %>% group_by(type,what,year.mon) %>%
                  dplyr::summarise(value=mean(value)),
            color="black") +
  facet_grid(rows=vars(what),cols=vars(type), scale="free_y")+
  theme_minimal() +
  scale_x_date(labels = date_format("%Y-%m")) +
  ylab(" ") + xlab("Month") 
# ggsave(paste(getwd(), "/output/", "predictors.jpeg", sep=""), 
#        width=9, height=13)


```


# llag analysis
Note: If vars changed above, re-run llag analysis below
```{r}
lag.length <- 6

# ##########################################################################
# #-- llag.fun
# llag.fun <- function(input.df){
#   ## drop vars has no variation (this is to ensure llag analysis will work)
#   temp <- input.df %>% group_by(destination) %>%
#     dplyr::summarise_all(.funs = sd)
#   temp[, 3:ncol(temp)][temp[, 3:ncol(temp)]==0] <- NA
#   temp <- temp[ , colSums(is.na(temp)) == 0]
#   varlist <- colnames(temp)
#   input.df <- input.df[, varlist]
# 
#   # load data for llag
#   temp <- xts(input.df[, 3:ncol(input.df)], order.by = input.df$year.mon, frac=1.)
# 
#   # lead lag estimate
#   delta.n <- 1
#   delta <- 1/delta.n
#   yuima <- setYuima(setData(temp,delta=delta))
#   ll <- llag(yuima, grid=seq(-lag.length*delta, lag.length*delta, by=delta),
#              ci=TRUE, plot=F)
#   temp <- cbind(ll$lagcce[,1]*delta.n, ll$p.values[,1], ll$LLR[,1]) |> as.data.frame()
#   colnames(temp) <- c("lag", "p.val", "LLR")
#   temp$destination <- unique(input.df$destination)
#   temp$vars <- rownames(temp)
#   rownames(temp) <- NULL
# 
#   output <- temp
#   return(output)
# }
# 
# #-- run
# cl <- makeCluster(detectCores()-1)
# clusterEvalQ(cl, pacman::p_load(caret, tidyverse, xts, yuima,
#                                 foreach))
# registerDoParallel(cl)
# 
# foreach(i=1:length(dest.name)) %dopar% {
#   input.df <- left_join(df.y.ma %>% filter(year.mon<=cutoff.time),
#                         df.x.train) %>%
#     filter(destination==dest.name[i])
# 
#   # llag on train.df only
#   output <- llag.fun(input.df=input.df)
#   saveRDS(output, paste(getwd(), "/output/",
#                         "llag.pars.df.", dest.name[i], ".rds", sep=""))
# }
# 
# stopCluster(cl)
# registerDoSEQ()


```



# llag.pars to llag.df
```{r}
##########################################################################
#-- llag.to.df.fun
llag.to.df.fun <- function(llag.pars, input.df){

  ## apply llag results to training data
  sig.lag <- llag.pars 
  sig.lag.list <- unique(sig.lag$vars)
  llag.df <- subset(input.df,
                    select=c(destination, year.mon)) %>%
    arrange(destination, year.mon)
  for (j in sig.lag.list) {
    lag <- sig.lag[sig.lag$vars==j, "lag"]
    temp <- input.df
    temp <- xts(temp[,j], order.by = temp$year.mon, frac=1.)
    temp <- lag.xts(temp, k=lag)
    names(temp) <- j
    llag.df <- cbind(llag.df, temp)
  }
  
  return(llag.df)
}

#-- run
output <- list()
for(i in 1:length(dest.name)){
  
  output[[dest.name[i]]] <- list()

  ## pre-select lags
  llag.pars <- readRDS(paste(getwd(), "/output/",
        "llag.pars.df.", dest.name[i], ".rds", sep=""))
  llag.pars <- subset(llag.pars, 
                      # criteria x lead y greater than holdout periods
                      lag>0 & lag<=lag.length 
                      # criteria xy lead lag ratio >1
                      & LLR>1 
                      # criteria lag significant at 95%
                      & p.val<0.1
                      )  

  ######################################################
  # Note: If drop vars, filter out corresponding llag.pars here
  llag.pars <- llag.pars %>% 
    filter(
      !grepl("gdp",vars)  
      & !grepl("v_",vars) # Drop v
      & !grepl("twitter",vars) # Drop twitter
      & !grepl("Drought",vars) # Drop twitter
      & !grepl("SAVI",vars) # Drop twitter
      )
  ######################################################
  
  output[[dest.name[i]]][["llag.pars"]] <- llag.pars

  #-- llag to df
  y.mom <- 2
    ## Training
  input.df <- df.x.train %>% filter(destination==dest.name[i])
  temp <- llag.to.df.fun(llag.pars=llag.pars,input.df=input.df)
      # from lag.length + 1
  temp <- temp[(lag.length+1):nrow(temp),]
      # ar
  # temp <- df.y.ma %>% filter(destination==dest.name[i]) %>%
  #   mutate(ar=dplyr::lag(y, 1, order_by = year.mon)) %>%
  #   right_join(., temp)
  temp <- df.y.ma %>% filter(destination==dest.name[i]) %>%
    dplyr::mutate(
      ar=zoo::rollapply(y, y.mom, mean,
                        align='right',partial=T, order_by=year.mon),
      # ar=dplyr::lag(ar, 1, order_by = year.mon),
      ) %>%
    right_join(., temp)
  
  #   # seasonality
  # temp <- temp %>% mutate(mon=(month(year.mon)) ) %>% 
  #   mutate(Dec=ifelse(mon %in% c(12), 1, 0),
  #          Nov=ifelse(mon %in% c(11), 1, 0),) %>% 
  #   select(-mon)

  output[[dest.name[i]]][["llag.df.x.train"]] <- temp

    ## testing
  input.df <- df.x %>% filter(destination==dest.name[i])
  temp <- llag.to.df.fun(llag.pars=llag.pars,input.df=input.df)
      # from lag.length + 1
  temp <- temp[(lag.length+1):nrow(temp),]
      # ar
  # temp <- df.y.ma %>% filter(destination==dest.name[i]) %>%
  #   mutate(ar=dplyr::lag(y, 1, order_by = year.mon)) %>%
  #   right_join(., temp)
  temp <- df.y.ma %>% filter(destination==dest.name[i]) %>%
    dplyr::mutate(
      ar=zoo::rollapply(y, y.mom-1, mean,
                        align='right',partial=T, order_by=year.mon),
      ar=dplyr::lag(ar, 1, order_by = year.mon),
      ) %>%
    right_join(., temp)
  
  #   # seasonality
  # temp <- temp %>% mutate(mon=(month(year.mon)) ) %>% 
  #    mutate(Dec=ifelse(mon %in% c(12), 1, 0),
  #          Nov=ifelse(mon %in% c(11), 1, 0),) %>% 
  #   select(-mon)
  
  output[[dest.name[i]]][["llag.df.x"]] <- temp
  
  saveRDS(output, paste(getwd(), "/output/","llag.df", ".rds", sep=""))
}

```


# plot sig llag
```{r}
# Plot sig lags
llag.par <- c()
for (i in 1:length(dest.name)) {
  temp <- readRDS(paste(getwd(), "/output/","llag.df", ".rds", sep=""))[[dest.name[i]]][["llag.pars"]]
  llag.par <- bind_rows(llag.par, temp)
}

plot.df <- llag.par %>% 
  dplyr::mutate(vars.grp=vars,
         vars.grp=ifelse(grepl("Drought.", vars), 
                         paste(word(vars, 1,1,sep="_"), 
                               word(vars, 2,2,sep="-")), 
                         vars.grp),
         vars.grp=ifelse(grepl("gdelt", vars), 
                         paste(word(vars, 1,1,sep="_"), "GDT:",word(vars, 3,3,sep="-")), vars.grp),
         vars.grp=ifelse(grepl("SAVI", vars), 
                         paste(word(vars, 1,1,sep="_"), 
                               word(vars, 2,2,sep="-")), 
                         vars.grp),
         vars.grp=ifelse(grepl("SPEI", vars), 
                         paste(word(vars, 1,1,sep="_"), 
                               word(vars, 2,2,sep="-")), 
                         vars.grp),
         vars.grp=ifelse(grepl("Soil moisture index", vars), 
                         paste(word(vars, 1,1,sep="_"), 
                               word(vars, 2,2,sep="-")), 
                         vars.grp),
          vars.grp=ifelse(grepl("spill", vars), 
                 paste(word(vars, 1,1,sep="_")),  
                 vars.grp),
         )


plot.df %>%
  ggplot(aes(x = vars.grp, y = lag)) +
    facet_wrap(.~destination, nrow=2) + #, scales = "free_x"
    geom_boxplot()+
    geom_hline(yintercept = 0, color="darkblue",linetype="dashed") +
    coord_flip()+
    theme_bw() + xlab("")+ylab("Lags") +
    theme(legend.position = "bottom",
          axis.text.x=element_text(angle=0))
ggsave(paste(getwd(), "/output/", "sig.lag.jpeg", sep=""),
       width=10, height=8)


#-- plot sig x
plot.df <- c()
for (i in 1:length(dest.name)) {
  temp <- readRDS(paste(getwd(), "/output/","llag.df", ".rds", sep=""))[[dest.name[i]]][["llag.df.x.train"]]
  plot.df <- bind_rows(plot.df, temp)
}

plot.df <- plot.df %>% ungroup %>%  dplyr::select(-c(y,ar)) %>%
  gather(key,value,-c(year.mon,destination)) %>%
  filter(!grepl("spill",key)) %>%
  mutate(type=word(key,1,1,sep="_"),
         res=word(key,2,2,sep="_")
         )
plot.df <- plot.df %>%
  mutate(what=ifelse(grepl("gdelt", res),
                     paste("GD:",word(res, 3,3,sep="-")),
                     word(res, 2,2,sep="-")))

temp <- dplyr::select(llag.par, c(destination, vars, lag)) %>% 
  dplyr::rename(key=vars)

plot.df <- left_join(plot.df, temp)

ggplot(plot.df %>% filter(!is.na(value)), aes(x=year.mon, y=value,group=key) ) +
  facet_wrap(.~destination,ncol=4)+
  geom_line(aes(color=what,alpha=lag), size=.6,
          show.legend=T)+
  scale_color_brewer(palette = "Set2")+
  theme_bw() +
  scale_x_date(labels = date_format("%Y")) +
  theme(legend.title = element_blank(),legend.position="bottom")+
  ylab(" ") + xlab("")
ggsave(paste(getwd(), "/output/", "predictors.jpeg", sep=""),
       width=8, height=10)

```



# Rolling window
```{r}
train.df <- readRDS(paste(getwd(), "/output/",
                      "llag.df", ".rds", sep="") )[[dest.name[1]]]$llag.df.x.train %>% drop_na()

#-- Data Split
  # split pars
fixedWindow <- T
total.period <- sort(unique(train.df$year.mon))
train.window <- 22
test.horizon <- testing.periods
data.split <- createTimeSlices(total.period, 
                              initialWindow = train.window, 
                              horizon = test.horizon,
                              fixedWindow = fixedWindow)
  # Plot splits
plot.df <- bind_rows(
  tibble(year.mon = data.split$train) %>% dplyr::mutate(spl.id=row_number()) %>% 
    unnest(year.mon) %>% 
    dplyr::mutate(year.mon=total.period[year.mon],
           spl.set="Training") ,
  tibble(year.mon = data.split$test) %>% dplyr::mutate(spl.id=row_number()) %>% 
    unnest(year.mon) %>% 
    dplyr::mutate(year.mon=total.period[year.mon],
           spl.set="Validation") 
) 

ggplot(plot.df, aes(x=as.factor(spl.id), y=year.mon)) +
  geom_tile(aes(fill=spl.set), color="white") +
    scale_color_viridis_d() +
    scale_fill_viridis_d() +
  theme_bw() +
  theme(legend.title = element_blank()) +
  coord_flip() +
  xlab("Fold ID") + ylab("")
ggsave(paste(getwd(), "/output/",
                      "rollWindow", ".jpeg", sep=""))

```



# Function: llag.glmnet
```{r}

#-- main function
my.llag.glmnet.fun <- function(input.df, dest.name, test.horizon,
                               alpha, lambda){
  
  input.df <- subset(input.df, select=-c(destination))
  effective.x <- input.df %>% dplyr::select(-c(y,year.mon))
  col.index <-  tibble(col.name=colnames(effective.x)) %>%
    mutate(col.index=row_number()) %>% filter(col.name=="ar")
  p.fac <- rep(1,ncol(effective.x))
  p.fac[col.index$col.index] <- 1
  
  ## ElasticNet feature selection
  myTimeControl.serial <- trainControl(method = "timeslice",
                                initialWindow = nrow(input.df)-test.horizon,
                                horizon = test.horizon,
                                fixedWindow = fixedWindow,
                                allowParallel = F)
        
  if (ncol(input.df)<=4) mod <- NULL
        else mod <- train(y~ . -year.mon,
               data=input.df,
                method = "glmnet",
                family = "gaussian",
                trControl = myTimeControl.serial,
                tuneGrid = expand.grid(alpha=alpha, lambda=lambda),
                metric='RMSE',
                penalty.factor = p.fac
               )

  return(mod)
}

  
  
```


# Function: AICc BIC 
```{r}
cv_aicc <- function(mod){
  # result in grid
  dev.ratio <- mod$finalModel$dev.ratio
  k <- mod$finalModel$df
  n <- mod$finalModel$nobs
  p.dev.ratio=dev.ratio * (n-1-k)/(n-1)

  # optimum
  whlm <- which(p.dev.ratio==max(p.dev.ratio) )
  
  # optimal results
  lambda <- mod$finalModel$lambda[whlm]
  nulldev <- mod$finalModel$nulldev
  dev.ratio <- mod$finalModel$dev.ratio[whlm]
  p.dev.ratio <- p.dev.ratio[whlm]
  tLL <- nulldev - nulldev * (1 - dev.ratio)
  k <- k[whlm]; n <- n

  return(list(
             'AIC' = 2*k - tLL ,
             'AICc' = 2*k - tLL + 2*k*(k+1) / (n-1-k) ,
             'BIC' = log(n)*k - tLL ,
             'p.dev.ratio'= p.dev.ratio,
             'dev.ratio'= dev.ratio,
             'n'= n,
             'k'= k,
             'lambda'=lambda
             )
          )
   }
```


# tuning lambda
```{r}
alpha <- .5

lambda.lo <- 0
lambda.up <- 1
lambda.s <- .01
  
#####################################################################
cl <- makeCluster(detectCores()-1)
clusterEvalQ(cl, pacman::p_load(caret, tidyverse, xts,
                                foreach))
registerDoParallel(cl)

foreach(i=1:length(dest.name)) %dopar% {
  
    # get data
  get.df <- 
    readRDS(paste(getwd(), "/output/", "llag.df", ".rds", sep=""))
  get.df <- get.df[[dest.name[i]]]$llag.df.x.train
  
  mod <- list()
  for(j in 1:length(data.split$train)){

      # get index from data.split
      train.index <- data.split$train[j] |> unlist()
      names(train.index) <- NULL
      train.window <- length(train.index)
      test.index <- data.split$test[j] |> unlist()
      names(test.index) <- NULL
      test.horizon <- length(test.index)
      all.index <- c(unlist(train.index), unlist(test.index))
    
      input.df <- get.df[all.index,] 

 mod[[j]] <- my.llag.glmnet.fun(input.df=input.df,
                                 dest.name=dest.name[i],
                                 test.horizon=test.horizon,
                                 alpha=alpha,
                                 # lambda=seq(lambda.lo,lambda.up,lambda.s)
                                 lambda=.5
                                 )
  }
  saveRDS(mod, paste(getwd(), "/output/", "llag.glmnet.tune", dest.name[i], ".rds", sep="") ) 
}

stopCluster(cl)
registerDoSEQ()
#####################################################################

# -- gather tuning results 
coef.result <- c()
bestTune.result <- c()
vip.result <- c()
for (i in 1:length(dest.name)) {
  get.df <- readRDS(paste(getwd(), "/output/", "llag.glmnet.tune", dest.name[i], ".rds", sep=""))
  for (j in 1:length(data.split$train)) {
    if(length(get.df)==0) result=NULL 
      else result <- get.df[[j]]
    pred.year.mon <- min(result$trainingData$year.mon)

    if(is.null(result)) temp <- NULL else{
      temp <- coef(result$finalModel, cv_aicc(mod=result)$lambda)
      temp <- as.data.frame(as.matrix(temp))
      temp$vars=row.names(temp)
      row.names(temp) <- NULL
      temp$destination <- dest.name[i]
      temp$pred.year.mon <- pred.year.mon
    }
    coef.result <- rbind(coef.result, temp) 
    
    if(is.null(result)) temp <- NULL else{
      temp <- result$bestTune
      temp$destination <- dest.name[i]
      temp$pred.year.mon <-pred.year.mon
      temp$aicc <- cv_aicc(mod=result)$AICc
      temp$aic <- cv_aicc(mod=result)$AIC
      temp$bic <- cv_aicc(mod=result)$BIC
      temp$p.dev.ratio <- cv_aicc(mod=result)$p.dev.ratio
      temp$dev.ratio <- cv_aicc(mod=result)$dev.ratio
      temp$n <- cv_aicc(mod=result)$n
      temp$k <- cv_aicc(mod=result)$k
      temp$lambda <- cv_aicc(mod=result)$lambda
    }
    bestTune.result <- rbind(bestTune.result, temp)
    
    if(is.null(result)) temp <- NULL else{
      temp <- varImp(result$finalModel, lambda=cv_aicc(mod=result)$lambda)
      temp$vars <- row.names(temp)
      row.names(temp) <- NULL
      temp$destination <- dest.name[i]
      temp$pred.year.mon <-pred.year.mon 
    }
    vip.result <- rbind(vip.result, temp) 
  }
}

saveRDS(coef.result, paste(getwd(), "/output/", "coef.result", ".rds", sep=""))
saveRDS(bestTune.result, paste(getwd(), "/output/", "bestTune.result", ".rds", sep=""))
saveRDS(vip.result, paste(getwd(), "/output/", "vip.result", ".rds", sep=""))

coef.result %>% filter(vars=="ar")

temp <- readRDS(paste(getwd(), "/output/", "bestTune.result", ".rds", sep="")) %>%
  subset(select=c(alpha, lambda, n,k,dev.ratio, p.dev.ratio, destination, pred.year.mon)) 
temp
```


# tuned lambda 
```{r}
#-- lambda
bestTune.result <- 
  readRDS(paste(getwd(), "/output/", "bestTune.result", ".rds", sep="")) 

ggplot(bestTune.result, aes(x=pred.year.mon, y=lambda))+
  geom_point(shape=1) + geom_line(color="blue") +
  facet_wrap(.~destination, ncol=4) #, scales="free_y"
ggsave(paste(getwd(), "/output/", "tv_lambda.jpeg",  sep=""),
       width=10, height=10)

tuned.lambda <- bestTune.result %>% dplyr::select(destination) %>% distinct()

##########################################################################
  ## compute lambda that maximizes penalized dev.ratio
temp <- bestTune.result %>%
  subset(select=c(alpha, lambda, p.dev.ratio, n, destination, pred.year.mon)) %>%
  mutate(ic=p.dev.ratio, lambda=round(lambda, 2)) 

opt.lambda <- temp %>% group_by(destination) %>% 
  dplyr::mutate(optimum=max(ic,na.rm=T)) %>%filter(ic==optimum) %>% 
  mutate(opt.lambda=lambda) %>% 
  dplyr::select(destination, opt.lambda, optimum)

temp <- left_join(temp,opt.lambda) %>% 
  mutate(label=paste(destination," | Opt.Lambda ",opt.lambda,sep=""))

    ### plot
ggplot(temp, aes(x=lambda, y=ic)) +
  geom_point(shape=1,size=1, alpha=.5) + 
  geom_line(color="blue", alpha=.5, width=.3) +
  geom_point(data=temp %>% 
               filter(ic==optimum),
             aes(x=opt.lambda, y=ic), color="red", shape=3,size=2.5)+
  facet_wrap(.~label, ncol=4, 
             #scales="free"
             ) +
  ylab("Penalized Deviance Ratio")
ggsave(paste(getwd(), "/output/", "min.rmse.npar.lambda.jpeg",  sep=""),
       width=8, height=8)

ggplot(temp, aes(x=pred.year.mon, y=label)) +
    geom_tile(aes(fill= ic)) +
    geom_text(aes(label =round(ic,3)),
            color="black", size=2.8) +
    scale_fill_gradient2(low = "white",
                         high = "darkgreen")+
    theme_minimal() + xlab("")+ylab("") +
    theme(legend.position = "right", legend.title = element_blank(),
          # strip.background = element_blank(),
          # strip.text.x = element_blank()
          )
ggsave(paste(getwd(), "/output/", "errorComplexScore.jpeg",  sep=""),
       width=8, height=8)

temp <- temp %>% filter(ic==optimum) %>%
  dplyr::select(destination,lambda,n, ic) %>% distinct() %>%
  dplyr::select(-ic)%>% dplyr::rename(dev.labmda=lambda)

tuned.lambda <- left_join(tuned.lambda, temp)


####################################################################
tuned.lambda$DynENet=tuned.lambda$dev.labmda

tuned.lambda 

which.lambda <- "DynENet"
```


# Summarize coef
  ## Retrain using tuned lambda
```{r}
# sel.dest <- c("DEU","ITA","FRA")
sel.dest <- dest.name

#####################################################################
cl <- makeCluster(detectCores()-1)
clusterEvalQ(cl, pacman::p_load(caret, tidyverse, xts,
                                foreach))
registerDoParallel(cl)

foreach(i=1:length(sel.dest)) %dopar% {
  
    # get data
  get.df <- 
    readRDS(paste(getwd(), "/output/", "llag.df", ".rds", sep=""))
  get.df <- get.df[[sel.dest[i]]]$llag.df.x.train
  
  lambda <- tuned.lambda[tuned.lambda$destination==sel.dest[i], "DynENet"] |> as.numeric()
  
  mod <- list()
  for(j in 1:length(data.split$train)){

      # get index from data.split
      train.index <- data.split$train[j] |> unlist()
      names(train.index) <- NULL
      train.window <- length(train.index)
      test.index <- data.split$test[j] |> unlist()
      names(test.index) <- NULL
      test.horizon <- length(test.index)
      all.index <- c(unlist(train.index), unlist(test.index))
    
      input.df <- get.df[all.index,] 

 mod[[j]] <- my.llag.glmnet.fun(input.df=input.df,
                                 dest.name=sel.dest[i],
                                 test.horizon=test.horizon,
                                 alpha=alpha,
                                 # lambda=seq(lambda.lo,lambda.up,lambda.s)
                                 lambda=lambda
                                 )
  }
  saveRDS(mod, paste(getwd(), "/output/", "llag.glmnet.retrain", sel.dest[i], ".rds", sep="") ) 
}

stopCluster(cl)
registerDoSEQ()
#####################################################################

# -- gather results 
coef.result <- c()
vip.result <- c()
for (i in 1:length(sel.dest)) {
  get.df <- readRDS(paste(getwd(), "/output/", "llag.glmnet.retrain", sel.dest[i], ".rds", sep=""))
  for (j in 1:length(data.split$train)) {
    if(length(get.df)==0) result=NULL 
      else result <- get.df[[j]]
    pred.year.mon <- min(result$trainingData$year.mon)

    if(is.null(result)) temp <- NULL else{
      temp <- coef(result$finalModel, result$bestTune$lambda)
      temp <- as.data.frame(as.matrix(temp))
      temp$vars=row.names(temp)
      row.names(temp) <- NULL
      temp$destination <- sel.dest[i]
      temp$pred.year.mon <- pred.year.mon
    }
    coef.result <- rbind(coef.result, temp) 
    
   if(is.null(result)) temp <- NULL else{
      temp <- varImp(result$finalModel, lambda=cv_aicc(mod=result)$lambda)
      temp$vars <- row.names(temp)
      row.names(temp) <- NULL
      temp$destination <- dest.name[i]
      temp$pred.year.mon <-pred.year.mon 
    }
    vip.result <- rbind(vip.result, temp) 
  }
}

# # drop zeroed out coef
# coef.result <- filter(coef.result, s1!=0)

```


  ## coef by dest + fold
```{r}
###########################################################################
#-- coef
input.df <- coef.result %>% filter(., s1!=0) %>% 
  dplyr::rename(Overall=s1) %>% 
  filter(vars!="(Intercept)" & vars!="ar" & !grepl("spill",vars)
         )

#-- create big categories
  ## Drought
input.df <- input.df %>% 
  dplyr::mutate(
    vars.grp=vars,
         vars.grp=ifelse(grepl("Drought.", vars), 
                         paste("CLM:", word(vars, 2,2,sep="-")), 
                         vars.grp),
         vars.grp=ifelse(grepl("gdelt", vars), 
                         paste("GD:",word(vars, 3,3,sep="-")),
                         # "GDELT",
                         vars.grp),
         vars.grp=ifelse(grepl("SAVI", vars), 
                         paste("CLM:", word(vars, 2,2,sep="-")), 
                         vars.grp),
         vars.grp=ifelse(grepl("SPEI", vars), 
                         paste("CLM:", word(vars, 2,2,sep="-")), 
                         vars.grp),
         vars.grp=ifelse(grepl("Soil moisture index", vars), 
                         paste("CLM:", word(vars, 2,2,sep="-")), 
                         vars.grp),
         vars.grp=ifelse(grepl("spill", vars), 
                         paste(word(vars, 1,1,sep="_")), 
                         vars.grp),
  )
  

input.df <- input.df %>% 
  mutate(vars.grp=ifelse(is.na(vars.grp), vars, vars.grp))
                         
plot.df <- c()
for (i in sel.dest) {
  temp <- subset(input.df,destination==i, 
               select=-destination) 

  temp <- temp %>% group_by(pred.year.mon, vars.grp) %>% 
    dplyr::summarise(Overall=mean(Overall,na.rm=T) )
    
  temp$destination=i
  plot.df <- bind_rows(plot.df, temp)

}

# plot.df <- plot.df %>% filter(abs(Overall)>0)
plot.df <- plot.df %>% filter(destination %in% sel.dest)
ggplot(plot.df, aes(x=pred.year.mon, y=vars.grp)) +
    geom_tile(aes(fill= Overall), color="black") +
    # geom_text(aes(label = paste(round(Overall*100,1),"%",sep="")), 
    #         color="black", size=2.8) +
    facet_wrap(destination~., nrow=4, #scales="free_y", 
               strip.position = c("top")) +
    scale_fill_gradient2(low = "darkred",
                       mid = "#FFFFCC",
                       high = "darkgreen") +
    theme_minimal() + xlab("")+ylab("") +
    theme(legend.position = "bottom", legend.title = element_blank(),
          axis.text.x = element_text(angle = 90)
          )+
  scale_x_date(labels = date_format("%y-%m"), breaks=pretty_breaks())
  
ggsave(paste(getwd(), "/output/", "coef.dest.",".jpeg", sep=""),
         width=8, height=8)


#   # relation k and y
# plot.df <- left_join(
#   input.df %>% 
#     group_by(destination, pred.year.mon) %>% dplyr::summarise(k=n()) %>% 
#     group_by(destination) %>% dplyr::summarise(k=log(mean(k))),
#   df.y %>% group_by(destination) %>%
#     dplyr::summarise(y=mean(y, na.rm=T))
# )
# 
# ggplot(plot.df, aes(x=y, y=k))+
#   geom_text(aes(label=destination, color=destination), show.legend = F) +
#     geom_smooth(se=F, method="lm", alpha=0.6, color="grey20")+
#   theme_minimal()+
#   xlab("Average Log ASR per Year") + ylab("Average Number of Selected Features per Fold")
# ggsave(paste(getwd(), "/output/", "k_y_cor",".jpeg", sep=""),
#          width=5, height=5)

```



  ## coef by district cluster
```{r}
# ###########################################################################
# #- Coef
# temp <- coef.result %>% filter(., s1!=0) %>%
#   dplyr::rename(Overall=s1) %>%
#   filter(!grepl("Intercept",vars)
#          & !grepl("spill",vars)
#          & !grepl("ar",vars)
#          # & destination %in% top.dest
#          )
# temp <- subset(temp,
#                which.lambda==which.lambda)
# 
# temp <- temp %>%
#   dplyr::mutate(res=ifelse(grepl("spill",vars),"", word(vars,2,2,sep="_")) )
# 
# temp <- temp %>%
#   dplyr::mutate(loc=res,
#          loc=ifelse(grepl("Drought.", res),
#                     paste(word(res, 1,1,sep="-")),
#                     loc),
#          loc=ifelse(grepl("gdelt", res),
#                     paste(word(res, 2,2,sep="-")),
#                     loc),
#          loc=ifelse(grepl("SAVI", res),
#                     paste(word(res, 1,1,sep="-")),
#                     loc),
#          loc=ifelse(grepl("SPEI", res),
#                     paste(word(res, 1,1,sep="-")),
#                     loc),
#          loc=ifelse(grepl("Soil moisture index", res),
#                     paste(word(res, 1,1,sep="-")),
#                     loc),
#          what=res,
#          what=ifelse(grepl("Drought.", res),
#                      paste("CLM:", word(res, 2,2,sep="-")),
#                      what),
#          what=ifelse(grepl("gdelt", res),
#                      paste("GD:",word(res, 3,3,sep="-")),
#                      # "GDELT",
#                      what),
#          what=ifelse(grepl("SAVI", res),
#                      paste("CLM:", word(res, 2,2,sep="-")),
#                      what),
#          what=ifelse(grepl("SPEI", res),
#                      paste("CLM:", word(res, 2,2,sep="-")),
#                      what),
#          what=ifelse(grepl("Soil moisture index", res),
#                      paste("CLM:", word(res, 2,2,sep="-")),
#                      what),
#          )
# 
# temp <- temp %>%
#   group_by(loc, what) %>%
#   dplyr::summarise(Overall=mean(Overall, na.rm=T))
# write.csv(temp, paste(getwd(), "/output/", "districtCoef",".csv", sep=""), row.names = F)
# 
# # temp <- temp %>% filter(abs(Overall)>0.)
# 
#   # index by destination
# destination_scale <- temp %>%
#   spread(key=what, value=Overall) %>%
#   replace(is.na(.), 0)
# destination_matrix <- as.matrix(destination_scale[, -c(1)])
# rownames(destination_matrix) <- destination_scale$loc
# destination_dendro <- as.dendrogram(
#   hclust(d = dist(x = destination_matrix, method="euclidean"),
#          method="ward.D"))
# 
#   # plot prep
# cuttree <- 1
# dend_data <- dendro_data(destination_dendro)
# segment_data <- with(segment(dend_data),
#     data.frame(x = y, y = x, xend = yend, yend = xend))
# pos_table <- with(
#   dend_data$labels, data.frame(y_center=x,loc=as.character(label),height=1)
#   )
# axis_limits <- with(
#     pos_table,
#     c(min(y_center - 0.5 * height), max(y_center + 0.5 * height)) ) +
#   0.1 * c(-1, 1) # extra spacing: 0.1
# 
#   # tile plot
# plot.df <- temp %>% left_join(.,pos_table)
# tile.plot <- ggplot(plot.df,
#                     aes(x=what, y=y_center)) +
#   geom_tile(aes(fill=Overall), color="white", alpha=.4) +
#   scale_fill_gradient2(low = "darkred",mid = "#FFFFCC",high = "darkgreen") +
#   geom_text(aes(label = paste(round(Overall,2),sep="")),
#             color="black", size=2.8, show.legend=F) +
#   theme_minimal() + xlab("")+ylab("") +
#   theme(legend.position = "right",legend.title = element_blank(),
#         axis.text.x=element_text(angle=90),
#         plot.margin = unit(c(1, 0.2, 0.2, -0.5), "cm"),
#         ) +
#   scale_y_continuous(expand = c(0,0),
#                     labels =pos_table$loc,
#                     breaks=pos_table$y_center,
#                     limits=axis_limits )
# 
#   # dendroplot
# destination_dendro_plot <- ggplot(segment_data) +
#   geom_segment(aes(x = x, y = y, xend = xend, yend = yend))  +
#   theme_minimal() + labs(x = "", y = "") +
#   geom_vline(aes(xintercept=cuttree), color="red", linetype="dashed") +
#   theme(axis.text.y = element_blank()) +
#   scale_x_reverse(expand = c(0, 0)) +
#   scale_y_continuous(expand = c(0,0),
#                     labels =pos_table$loc,
#                     breaks=pos_table$y_center,
#                     limits=axis_limits)
# 
# plot_grid(destination_dendro_plot, tile.plot,
#           nrow = 1, align = 'h',
#           rel_widths = c(1.5,3))
# 
# ggsave(paste(getwd(), "/output/", "coef.district",".jpeg", sep=""),
#        width=8, height=10)

```



  ## coef by district map
```{r}
pacman::p_load(BiocManager,rgeos,sf,raster)

#- Coef
temp <- coef.result %>% filter(., s1!=0) %>% 
  dplyr::rename(Overall=s1) %>% 
  filter(!grepl("Intercept",vars) 
         & !grepl("spill",vars)
         & !grepl("ar",vars)
         # & destination %in% top.dest 
         )
temp <- subset(temp,
               which.lambda==which.lambda)

temp <- temp %>%
  dplyr::mutate(res=ifelse(grepl("spill",vars),"", word(vars,2,2,sep="_")) )

temp <- temp %>%
  dplyr::mutate(loc=res,
         loc=ifelse(grepl("Drought.", res),
                    paste(word(res, 1,1,sep="-")),
                    loc),
         loc=ifelse(grepl("gdelt", res),
                    paste(word(res, 2,2,sep="-")), 
                    loc),
         loc=ifelse(grepl("SAVI", res),
                    paste(word(res, 1,1,sep="-")),
                    loc),
         loc=ifelse(grepl("SPEI", res),
                    paste(word(res, 1,1,sep="-")),
                    loc),
         loc=ifelse(grepl("Soil moisture index", res),
                    paste(word(res, 1,1,sep="-")),
                    loc),
         what=res,
         what=ifelse(grepl("Drought.", res),
                     paste("CLM:", word(res, 2,2,sep="-")), 
                     what),
         what=ifelse(grepl("gdelt", res),
                     paste("GD:",word(res, 3,3,sep="-")),
                     # "GDELT",
                     what),
         what=ifelse(grepl("SAVI", res),
                     paste("CLM:", word(res, 2,2,sep="-")),
                     what),
         what=ifelse(grepl("SPEI", res),
                     paste("CLM:", word(res, 2,2,sep="-")),
                     what),
         what=ifelse(grepl("Soil moisture index", res),
                     paste("CLM:", word(res, 2,2,sep="-")),
                     what),
         )

temp <- temp %>%
  group_by(loc, what) %>%
  dplyr::summarise(Overall=mean(Overall, na.rm=T))
write.csv(temp, paste(getwd(), "/output/", "districtCoef",".csv", sep=""), row.names = F)

# -- prepare data
my.df <- read.csv(paste(getwd(), "/output/", "districtCoef",".csv", sep="")) %>% as_tibble()
what <- unique(my.df$what)

som <- readRDS(paste(getwd(),"/gadm36_SOM_2_sp.rds", sep="")) 
map <-fortify(som)
map$id <- as.integer(map$id)

dat <- data.frame(id=as.numeric(rownames(som@data))+1, state = som@data$NAME_2)
map_df <- inner_join(map, dat, by = "id")

#-- correct inconsistent names
true.name <- sort(unique(map_df$state))
temp <- my.df %>% 
  mutate(loc=ifelse(grepl("Adan ",loc), "Aadan",loc),
         loc=ifelse(grepl("Banadir",loc), "Mogadisho",loc),
         loc=ifelse(grepl("Baydhaba",loc), "Baydhabo",loc),
         loc=ifelse(grepl("Belet Weyne",loc), "Beled Weyn",loc),
         loc=ifelse(grepl("Belet Xaawo",loc), "Beled Xaawo",loc),
         loc=ifelse(grepl("Borama",loc), "Boorama",loc),
         loc=ifelse(grepl("Bossaso",loc), "Bosaaso",loc),
         loc=ifelse(grepl("Bulo Burto",loc), "Buulo Burdo",loc),
         loc=ifelse(grepl("Burco",loc), "Burao",loc),
         loc=ifelse(grepl("Buur Hakaba",loc), "Buur Xakaba",loc),
         loc=ifelse(grepl("Cabudwaaq",loc), "Caabudwaaq",loc),
         loc=ifelse(grepl("Caluula",loc), "Calawla",loc),
         loc=ifelse(grepl("Ceel Afweyn",loc), "Ceel-Afwein",loc),
         loc=ifelse(grepl("Doolow",loc), "Dolow",loc),
         loc=ifelse(grepl("Gaalkacyo",loc), "Gaalkacayo",loc),
         loc=ifelse(grepl("Galdogob",loc), "Goldogob",loc),
         loc=ifelse(grepl("Gebiley",loc), "Gabiley",loc),
         loc=ifelse(grepl("Laas Caanood",loc), "Lascaanod",loc),
         loc=ifelse(grepl("Laasqoray",loc), "Badhan",loc),
         loc=ifelse(grepl("Lughaye",loc), "Lughaya",loc),
         loc=ifelse(grepl("Luuq",loc), "Luuk",loc),
         loc=ifelse(grepl("Owdweyne",loc), "Oodweyne",loc),
         loc=ifelse(grepl("Sablaale",loc), "Sablale",loc),
         loc=ifelse(grepl("Sheikh",loc), "Sheekh",loc),
         loc=ifelse(grepl("Tayeeglow",loc), "Tiyeeglow",loc),
         loc=ifelse(grepl("Waajid",loc), "Wajid",loc),)
my.df <- temp
my.df <- my.df %>% dplyr::rename(state=loc) 

#-- Find a center point for each province
centers <- data.frame(gCentroid(som, byid = TRUE))
centers$state <- dat$state
centers <- left_join(my.df,centers)

#-- Function: map_theme 
theme_map <- function (base_size = 12, base_family = "") {
  theme_gray(base_size = base_size, base_family = base_family) %+replace% 
    theme(
      axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      axis.ticks.length=unit(0.3, "lines"),
      axis.ticks.margin=unit(0.5, "lines"),
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      legend.background=element_rect(fill="white", colour=NA),
      legend.key=element_rect(colour="white"),
      legend.key.size=unit(1.5, "lines"),
      legend.position="right",
      legend.text=element_text(size=rel(1.2)),
      legend.title=element_text(size=rel(1.4), face="bold", hjust=0),
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      panel.margin=unit(0, "lines"),
      plot.background=element_blank(),
      plot.margin=unit(c(1, 1, 0.5, 0.5), "lines"),
      plot.title=element_text(size=rel(1.8), face="bold", hjust=0.5),
      strip.background=element_rect(fill="white", colour="white"),
      strip.text.x=element_text(size=rel(0.8)),
      strip.text.y=element_text(size=rel(0.8), angle=-90) 
    )   
}

#-- plot
plot.df <- c()
for (i in what) {
  temp <- map_df %>% mutate(what=i)
  plot.df <- bind_rows(plot.df, temp)
}

plot.df <- my.df %>% 
  right_join(.,plot.df, by=c("state", "what")) 

  # compute number of districts
n.dist <- plot.df %>% dplyr::select(state, what, Overall) %>% distinct() %>%
  filter(!is.na(Overall)) %>%  
  group_by(what) %>% 
  dplyr::summarise(count=max(row_number()),
                   avg=round(mean(Overall), 2)) %>% 
  mutate(pos.x=max(plot.df$long)-3, pos.y=min(plot.df$lat)+1) %>% 
  mutate(lab=paste(
    paste("N.Dist.=",count,sep=""),
    paste("Avg.Coef.=",avg,sep=""),
    sep="\n")
    )

ggplot() +
  geom_map(data = plot.df, 
           map = plot.df,
           aes(map_id = id, x = long, y = lat, group = group,
               fill=Overall),
           color = "grey60") +
  geom_text(data = n.dist, 
            aes(x = pos.x, y = pos.y, label = lab),
             size=6)+
  ggrepel::geom_text_repel(
    data = centers,
    aes(label = state, x = x, y = y,
        size=abs(Overall), ),
    color="darkblue", alpha=.8) +
  coord_map() +
  labs(x = "", y = "") +
  theme_map() +
  scale_fill_gradient2(
    low = "darkred",mid = "lightyellow", high = "darkgreen",
    na.value="white"
    ) +
  facet_wrap(.~what, ncol=4) +
  theme(legend.title = element_blank(),
        legend.position = "right",
        strip.text.x = element_text(size=15),
        # legend.text = element_text(size=3)
        )
ggsave(paste(getwd(), "/output/", "coef.dest.map",".jpeg", sep=""),
       width=15, height=10)

```


  ## importance frequency
    ### IF coef
```{r}
# ###########################################################################
# #-- coef
# input.df <- coef.result %>% dplyr::rename(Overall=s1) %>% filter(., Overall!=0) %>% 
#   filter(vars!="(Intercept)" & vars!="ar" & !grepl("spill",vars)
#          )
# 
# #-- create big categories
#   ## Drought
# input.df <- input.df %>% 
#   dplyr::mutate(
#     vars.grp=vars,
#          vars.grp=ifelse(grepl("Drought.", vars), 
#                          paste("CLM:", word(vars, 2,2,sep="-")), 
#                          vars.grp),
#          vars.grp=ifelse(grepl("gdelt", vars), 
#                          paste("GD:",word(vars, 3,3,sep="-")),
#                          # "GDELT",
#                          vars.grp),
#          vars.grp=ifelse(grepl("SAVI", vars), 
#                          paste("CLM:", word(vars, 2,2,sep="-")), 
#                          vars.grp),
#          vars.grp=ifelse(grepl("SPEI", vars), 
#                          paste("CLM:", word(vars, 2,2,sep="-")), 
#                          vars.grp),
#          vars.grp=ifelse(grepl("Soil moisture index", vars), 
#                          paste("CLM:", word(vars, 2,2,sep="-")), 
#                          vars.grp),
#          vars.grp=ifelse(grepl("spill", vars), 
#                          paste(word(vars, 1,1,sep="_")), 
#                          vars.grp),
#   )
#   
# 
# input.df <- input.df %>% 
#   mutate(vars.grp=ifelse(is.na(vars.grp), vars, vars.grp))
# 
# #-- var selected frequency
# x <- input.df %>% 
#   dplyr::mutate(varFreq=ifelse(Overall==0,0,1) )  %>% 
#   # start aggregate
#   group_by(destination, pred.year.mon, vars.grp) %>%
#   dplyr::summarise(varFreq=sum(varFreq)) %>%
#   group_by(destination, vars.grp) %>%
#   dplyr::summarise(varFreq=mean(varFreq))
# 
# #-- vip per model (i.e., per dest and per fold)
# y <- input.df %>%
#   group_by(destination, pred.year.mon) %>%
#   dplyr::mutate(vip=Overall,) %>%
#   # start aggregate
#   group_by(destination, pred.year.mon, vars.grp) %>%
#   dplyr::summarise(vip=mean(vip,na.rm=T)) %>%
#   group_by(destination, vars.grp) %>%
#   dplyr::summarise(vip=mean(vip))
# 
# #-- plot df
# plot.df <- left_join(x,y) 
# 
#   ## create thresholds
# sigLevel <- .95
# varFreq.m <- quantile(plot.df$varFreq, probs=sigLevel)|> round(2)
# vip.m <- quantile(plot.df$vip, probs=sigLevel) |> round(2)
# 
#   ## classify quan qual
# plot.df <- plot.df %>% 
#   mutate(
#     qq=ifelse(vip>vip.m & varFreq<=varFreq.m,"Qual.Imp",
#               ifelse(vip>vip.m & varFreq>varFreq.m,"Qual-Quan.Imp",
#                      ifelse(vip<=vip.m & varFreq>varFreq.m,"Quan.Imp", "Not.Imp")
#                      )
#               )
#     )
# 
# formula <- y~x-1
# ggplot(plot.df %>% filter(destination %in% sel.dest), 
#        aes(x=(varFreq), y=(vip))) +
#     stat_smooth(color="grey30", 
#                 method = "lm", formula = formula, se=F) +
#     stat_regline_equation(
#       aes(label= ..eq.label..,),
#       formula = formula, 
#       label.x=max(plot.df$varFreq)*.55,) +
#     geom_hline(yintercept = 0, linetype="dashed",color="grey50") +
#     geom_point(alpha=.8, size=2.2)+
#     ggrepel::geom_text_repel(
#       aes(label = paste(destination, sep="")),
#       size=2.5, alpha=.8, show.legend = F) +
#     theme_bw() + 
#     facet_wrap(.~ vars.grp, ncol=4) +
#     xlab("Number of Times Variable Selected (Sum across All Folds)")+
#     ylab("Relative Rank of Variable Importance (Sum across All Folds)") +
#     theme(legend.position = "bottom", legend.title = element_blank() )+
#     scale_shape_manual(values=1:length(unique(plot.df$vars.grp)) )
# ggsave(paste(getwd(), "/output/", "IF.vip.space",".jpeg", sep=""),
#          width=8, height=6)

```



    ### IF vip by dest
```{r}
# ###########################################################################
# #-- coef
# input.df <- vip.result %>% #filter(., Overall!=0) %>% 
#   filter(vars!="(Intercept)" & vars!="ar" & !grepl("spill",vars)
#          )
# 
# #-- create big categories
#   ## Drought
# input.df <- input.df %>% 
#   dplyr::mutate(
#     vars.grp=vars,
#          vars.grp=ifelse(grepl("Drought.", vars), 
#                          paste("CLM:", word(vars, 2,2,sep="-")), 
#                          vars.grp),
#          vars.grp=ifelse(grepl("gdelt", vars), 
#                          paste("GD:",word(vars, 3,3,sep="-")),
#                          # "GDELT",
#                          vars.grp),
#          vars.grp=ifelse(grepl("SAVI", vars), 
#                          paste("CLM:", word(vars, 2,2,sep="-")), 
#                          vars.grp),
#          vars.grp=ifelse(grepl("SPEI", vars), 
#                          paste("CLM:", word(vars, 2,2,sep="-")), 
#                          vars.grp),
#          vars.grp=ifelse(grepl("Soil moisture index", vars), 
#                          paste("CLM:", word(vars, 2,2,sep="-")), 
#                          vars.grp),
#          vars.grp=ifelse(grepl("spill", vars), 
#                          paste(word(vars, 1,1,sep="_")), 
#                          vars.grp),
#   )
#   
# 
# input.df <- input.df %>% 
#   mutate(vars.grp=ifelse(is.na(vars.grp), vars, vars.grp))
# 
# #-- var selected frequency
# x <- input.df %>% 
#   dplyr::mutate(varFreq=ifelse(Overall==0,0,1) )  %>% 
#   # start aggregate
#   group_by(destination, pred.year.mon, vars.grp) %>%
#   dplyr::summarise(varFreq=sum(varFreq)) %>%
#   group_by(destination, vars.grp) %>%
#   dplyr::summarise(varFreq=sum(varFreq))
# 
# #-- vip per model (i.e., per dest and per fold)
# y <- input.df %>%
#   group_by(destination, pred.year.mon) %>%
#   dplyr::mutate(vip=Overall,
#                 vip=vip/sum(vip,na.rm=T)) %>%
#   # start aggregate
#   group_by(destination, pred.year.mon, vars.grp) %>%
#   dplyr::summarise(vip=sum(vip,na.rm=T)) %>%
#   group_by(destination, vars.grp) %>%
#   dplyr::summarise(vip=sum(vip))
# 
# #-- plot df
# plot.df <- left_join(x,y) 
# 
#   ## create thresholds
# sigLevel <- .95
# varFreq.m <- quantile(plot.df$varFreq, probs=sigLevel)|> round(2)
# vip.m <- quantile(plot.df$vip, probs=sigLevel) |> round(2)
# 
#   ## classify quan qual
# plot.df <- plot.df %>% 
#   mutate(
#     qq=ifelse(vip>vip.m & varFreq<=varFreq.m,"Qual.Imp",
#               ifelse(vip>vip.m & varFreq>varFreq.m,"Qual-Quan.Imp",
#                      ifelse(vip<=vip.m & varFreq>varFreq.m,"Quan.Imp", "Not.Imp")
#                      )
#               )
#     )
# 
# formula <- y~x-1
# ggplot(plot.df %>% filter(destination %in% sel.dest), 
#        aes(x=(varFreq), y=(vip))) +
#     stat_smooth(color="grey30", 
#                 method = "lm", formula = formula, se=F) +
#     stat_regline_equation(
#       aes(label= ..eq.label..,),
#       formula = formula, 
#       label.x=max(plot.df$varFreq)*.55,) +
#     geom_hline(yintercept = vip.m, linetype="dashed",color="grey50") +
#     geom_text(aes(x=max(varFreq)*.95,y=vip.m), 
#               label=paste("",(vip.m),sep="\n"), 
#               color="grey50",size=3.5 )+
#     geom_vline(xintercept = varFreq.m, linetype="dashed",color="grey50")+
#     geom_text(aes(y=max(vip)*.95,x=varFreq.m, angle = 90), 
#               label=paste("",(varFreq.m),sep="\n"), 
#               color="grey50",size=3.5 )+
#     geom_point(aes(color=qq), alpha=.8, size=2.2)+
#     ggrepel::geom_text_repel(
#       aes(label = paste(destination, sep=""),color=qq),
#       size=2.5, alpha=.8, show.legend = F) +
#     theme_bw() + 
#     facet_wrap(.~ vars.grp, ncol=4) +
#     xlab("Number of Times Variable Selected (Sum across All Folds)")+
#     ylab("Relative Rank of Variable Importance (Sum across All Folds)") +
#     theme(legend.position = "bottom", legend.title = element_blank() )+
#     scale_shape_manual(values=1:length(unique(plot.df$vars.grp)) )
# ggsave(paste(getwd(), "/output/", "IF.vip.space",".jpeg", sep=""),
#          width=8, height=6)

```



    ### IF vip by district-dest
```{r}
###########################################################################
#-- coef
input.df <- vip.result %>% #filter(., Overall!=0) %>% 
  filter(vars!="(Intercept)" & vars!="ar" & !grepl("spill",vars)
         )

#-- create big categories
input.df <- input.df %>%
  dplyr::mutate(res=ifelse(grepl("spill",vars),"", word(vars,2,2,sep="_")) )

input.df <- input.df %>%
  dplyr::mutate(loc=res,
         loc=ifelse(grepl("Drought.", res),
                    paste(word(res, 1,1,sep="-")),
                    loc),
         loc=ifelse(grepl("gdelt", res),
                    paste(word(res, 2,2,sep="-")), 
                    loc),
         loc=ifelse(grepl("SAVI", res),
                    paste(word(res, 1,1,sep="-")),
                    loc),
         loc=ifelse(grepl("SPEI", res),
                    paste(word(res, 1,1,sep="-")),
                    loc),
         loc=ifelse(grepl("Soil moisture index", res),
                    paste(word(res, 1,1,sep="-")),
                    loc),
         vars.grp=res,
         vars.grp=ifelse(grepl("Drought.", res),
                     paste("CLM:", word(res, 2,2,sep="-")), 
                     vars.grp),
         vars.grp=ifelse(grepl("gdelt", res),
                     paste("GD:",word(res, 3,3,sep="-")),
                     # "GDELT",
                     vars.grp),
         vars.grp=ifelse(grepl("SAVI", res),
                     paste("CLM:", word(res, 2,2,sep="-")),
                     vars.grp),
         vars.grp=ifelse(grepl("SPEI", res),
                     paste("CLM:", word(res, 2,2,sep="-")),
                     vars.grp),
         vars.grp=ifelse(grepl("Soil moisture index", res),
                     paste("CLM:", word(res, 2,2,sep="-")),
                     vars.grp),
         )
  
input.df <- input.df %>% 
  mutate(loc=ifelse(grepl("Adan ",loc), "Aadan",loc),
         loc=ifelse(grepl("Banadir",loc), "Mogadisho",loc),
         loc=ifelse(grepl("Baydhaba",loc), "Baydhabo",loc),
         loc=ifelse(grepl("Belet Weyne",loc), "Beled Weyn",loc),
         loc=ifelse(grepl("Belet Xaawo",loc), "Beled Xaawo",loc),
         loc=ifelse(grepl("Borama",loc), "Boorama",loc),
         loc=ifelse(grepl("Bossaso",loc), "Bosaaso",loc),
         loc=ifelse(grepl("Bulo Burto",loc), "Buulo Burdo",loc),
         loc=ifelse(grepl("Burco",loc), "Burao",loc),
         loc=ifelse(grepl("Buur Hakaba",loc), "Buur Xakaba",loc),
         loc=ifelse(grepl("Cabudwaaq",loc), "Caabudwaaq",loc),
         loc=ifelse(grepl("Caluula",loc), "Calawla",loc),
         loc=ifelse(grepl("Ceel Afweyn",loc), "Ceel-Afwein",loc),
         loc=ifelse(grepl("Doolow",loc), "Dolow",loc),
         loc=ifelse(grepl("Gaalkacyo",loc), "Gaalkacayo",loc),
         loc=ifelse(grepl("Galdogob",loc), "Goldogob",loc),
         loc=ifelse(grepl("Gebiley",loc), "Gabiley",loc),
         loc=ifelse(grepl("Laas Caanood",loc), "Lascaanod",loc),
         loc=ifelse(grepl("Laasqoray",loc), "Badhan",loc),
         loc=ifelse(grepl("Lughaye",loc), "Lughaya",loc),
         loc=ifelse(grepl("Luuq",loc), "Luuk",loc),
         loc=ifelse(grepl("Owdweyne",loc), "Oodweyne",loc),
         loc=ifelse(grepl("Sablaale",loc), "Sablale",loc),
         loc=ifelse(grepl("Sheikh",loc), "Sheekh",loc),
         loc=ifelse(grepl("Tayeeglow",loc), "Tiyeeglow",loc),
         loc=ifelse(grepl("Waajid",loc), "Wajid",loc),)

input.df <- input.df %>% 
  mutate(vars.grp=ifelse(is.na(vars.grp), vars, vars.grp)) %>% 
  mutate(fl=paste(loc,destination,sep="\n"))

#-- var selected frequency
x <- input.df %>% 
  dplyr::mutate(varFreq=ifelse(Overall==0,0,1) )  %>% 
  # start aggregate
  group_by(vars, vars.grp, fl) %>%
  dplyr::summarise(varFreq=mean(varFreq)) 

#-- vip per model (i.e., per dest and per fold)
y <- input.df %>%
  group_by(destination, pred.year.mon) %>%
  dplyr::mutate(vip=Overall,
                vip=vip/sum(vip,na.rm=T)) %>%
  # start aggregate
  group_by(vars, vars.grp, fl) %>%
  dplyr::summarise(vip=mean(vip,na.rm=T)) 

#-- plot df
plot.df <- left_join(x,y) 

  ## create thresholds
sigLevel <- .5
# varFreq.m <- quantile(plot.df$varFreq, probs=sigLevel)|> round(2)
# vip.m <- quantile(plot.df$vip, probs=sigLevel) |> round(2)
varFreq.m <- .5
vip.m <- .5

  ## classify quan qual
plot.df <- plot.df %>% 
  mutate(
    qq=ifelse(vip>vip.m & varFreq<=varFreq.m,"Lo.Prob-Hi.Imp",
              ifelse(vip>vip.m & varFreq>varFreq.m,"Hi.Prob-Hi.Imp",
                     ifelse(vip<=vip.m & varFreq>varFreq.m,"Hi.Prob-Lo.Imp", 
                            "Lo.Prob-Lo.Imp")
                     )
              )
    )

formula <- y~x+I(x^2)-1
ggplot(plot.df, 
       aes(x=(varFreq), y=(vip))) +
    facet_wrap(.~ vars.grp, ncol=4) +
    stat_smooth(color="grey38", alpha=.5, linetype="dashed",
                method = "lm", formula = formula, se=F) +
    stat_regline_equation(
      aes(label= ..eq.label..,),
      formula = formula, 
      label.x=min(plot.df$varFreq)*1.5,
      label.y=.7) +
    geom_hline(yintercept = vip.m, linetype="dashed",color="grey60") +
    # geom_text(aes(x=max(varFreq)*.95,y=vip.m),
    #           label=paste("",(vip.m),sep="\n"),
    #           color="grey60",size=3.5 )+
    geom_vline(xintercept = varFreq.m, linetype="dashed",color="grey60")+
    # geom_text(aes(y=max(vip)*.95,x=varFreq.m, angle = 90),
    #           label=paste("",(varFreq.m),sep="\n"),
    #           color="grey60",size=3.5 )+
    geom_point(aes(color=qq),alpha=1, size=2)+
    ggrepel::geom_text_repel(
      aes(label = paste(fl, sep=""),color=qq),
      size=2.2, alpha=.8, show.legend = F) +
    theme_bw() + 
    xlab("Frequency Variable Selected (per Fold)")+
    ylab("Relative Rank of Variable Importance (per Fold)") +
    theme(legend.position = "bottom", legend.title = element_blank() )+
    scale_shape_manual(values=1:length(unique(plot.df$vars.grp)) ) +
    scale_color_brewer(palette = "Dark2")
ggsave(paste(getwd(), "/output/", "IF.vip.space",".jpeg", sep=""),
         width=9, height=6)

```



# Final model
```{r}
# define which lambda to use
which.lambda <- c("DynENet") #
which.lambda <- which.lambda[1]

cl <- makeCluster(detectCores()-1)
clusterEvalQ(cl, pacman::p_load(caret, tidyverse, xts,
                                foreach))
registerDoParallel(cl)

foreach(i=1:length(dest.name)) %dopar% {
    # get data
    input.df <- 
      readRDS(paste(getwd(), "/output/", "llag.df", ".rds", sep=""))
    input.df <- input.df[[dest.name[i]]]$llag.df.x.train

        mod <- list()
        for (j in which.lambda) {
              lambda <- tuned.lambda[tuned.lambda$destination==dest.name[i], j] |> as.numeric()
              n <- tuned.lambda[tuned.lambda$destination==dest.name[i], "n"] |> as.numeric()

          mod[[j]] <- my.llag.glmnet.fun(
            input.df=input.df[(nrow(input.df)-n+1):nrow(input.df),],
            dest.name=dest.name[i],
            test.horizon=test.horizon,
            alpha=alpha, lambda=lambda)
          }    
          saveRDS(mod, paste(getwd(), "/output/", "final.glmnet.result", dest.name[i], ".rds", sep="") )
}

stopCluster(cl)
registerDoSEQ()


#-- gather model estimates for all countries
coef.result <- c()
bestTune.result <- c()
for (i in 1:length(dest.name)) {
    get.df <- readRDS(paste(getwd(), "/output/", "final.glmnet.result", dest.name[i], ".rds", sep=""))
  for (j in which.lambda) {
    if(length(get.df)==0) result <- NULL else 
      result <- get.df[[j]]

    if(is.null(result)) temp <- NULL else{
      temp <- coef(result$finalModel, result$bestTune$lambda) 
      temp <- as.data.frame(as.matrix(temp))
      colnames(temp) <- c("coef")
      temp$vars=row.names(temp)
      temp$destination <- dest.name[i]
      temp$which.lambda <- j
      row.names(temp) <- NULL
    }
      coef.result <- rbind(coef.result, temp)
    
    if(is.null(result)) temp <- NULL else{
      temp <- result$bestTune
      temp$destination <- dest.name[i]
      temp$which.lambda <- j
    }
      bestTune.result <- rbind(bestTune.result, temp)

      }
}


```



# Coef by vars and destination
  ## individual var 
```{r}
# ###########################################################################
# #- Coef
# temp <- coef.result %>% filter(!grepl("Intercept",vars) 
#                                & !grepl("spill",vars)
#                                & !grepl("ar",vars)
#                                & destination %in% top.dest
#                                )
# temp <- subset(temp,
#                which.lambda==which.lambda)
# 
# temp <- temp %>%
#   mutate(res=ifelse(grepl("spill",vars),"", word(vars,2,2,sep="_")) )
# 
# temp <- temp %>%
#   mutate(loc=res,
#          loc=ifelse(grepl("Drought.", res),
#                     paste(word(res, 1,1,sep="-")),
#                     loc),
#          loc=ifelse(grepl("gdelt", res),
#                     paste(word(res, 2,2,sep="-")), 
#                     loc),
#          loc=ifelse(grepl("SAVI", res),
#                     paste(word(res, 1,1,sep="-")),
#                     loc),
#          loc=ifelse(grepl("SPEI", res),
#                     paste(word(res, 1,1,sep="-")),
#                     loc),
#          loc=ifelse(grepl("Soil moisture index", res),
#                     paste(word(res, 1,1,sep="-")),
#                     loc),
#          what=res,
#          what=ifelse(grepl("Drought.", res),
#                      paste(word(res, 2,2,sep="-")), 
#                      what),
#          what=ifelse(grepl("gdelt", res),
#                      # paste("GD:",word(res, 3,3,sep="-")),
#                      "GDELT",
#                      what),
#          what=ifelse(grepl("SAVI", res),
#                      paste(word(res, 2,2,sep="-")),
#                      what),
#          what=ifelse(grepl("SPEI", res),
#                      paste(word(res, 2,2,sep="-")),
#                      what),
#          what=ifelse(grepl("Soil moisture index", res),
#                      paste(word(res, 2,2,sep="-")),
#                      what),
#          )
# 
# temp <- temp %>% 
#   mutate(vars.grp=paste(what,loc,sep="_"),
#          vars.grp=ifelse(grepl("ar_",vars.grp),"ar",vars.grp))
# 
# temp <- temp %>%
#   group_by(destination, vars.grp) %>%
#   dplyr::summarise(Overall=mean(coef, na.rm=T))
# 
# #   # index by destination
# # destination_scale <- temp %>%
# #   spread(key=vars.grp, value=Overall) %>%
# #   replace(is.na(.), threshold)
# # destination_matrix <- as.matrix(destination_scale[, -c(1)])
# # rownames(destination_matrix) <- destination_scale$destination
# # destination_dendro <- as.dendrogram(hclust(d = dist(x = destination_matrix),
# #                                      method="single"))
# # destination_dendro_plot <- ggdendrogram(data = destination_dendro)
# # destination_order <- order.dendrogram(destination_dendro)
# # 
# # temp$destination <- factor(x = temp$destination,
# #                       levels = destination_scale$destination[destination_order],
# #                       ordered = TRUE)
# 
# plot.df <- temp %>% 
#   mutate(loc=ifelse(vars.grp=="ar","AR",
#                       word(vars.grp,2,2,sep="_")),
#          what=ifelse(vars.grp=="ar","AR",
#                       word(vars.grp,1,1,sep="_"))
#          ) 
# 
# plot.df <- plot.df %>% filter(abs(Overall)>0.05)
# tile.plot <- ggplot(plot.df,
#                     aes(x = destination, y = vars.grp)) +
#   geom_tile(aes(fill=Overall), color="white", alpha=.4) +
#   scale_fill_gradient2(low = "darkred",mid = "#FFFFCC",high = "darkgreen") +
#   geom_text(aes(label = paste(round(Overall,1),sep="")),
#             color="black", size=2.8, show.legend=F) +
#   theme_minimal() + xlab("")+ylab("") +
#   theme(legend.position = "right",legend.title = element_blank(),
#         axis.text.x=element_text(angle=90),
#         strip.text.y = element_blank()
#         ) +
#   facet_grid(rows=vars(loc), scales = "free", space = "free",
#              )
# 
# # top.plot <- plot_grid(NULL,destination_dendro_plot,ncol=2, rel_widths = c(1, 3.2))
# # plot_grid(top.plot, tile.plot, ncol = 1,
# #           rel_heights = c(1.5,8.5), align = 'v', axis = "bt")
# 
# ggsave(paste(getwd(), "/output/", "coef.dest.cluster",".jpeg", sep=""),
#        width=8, height=10)

```



# benchmark
```{r}
bm.mod <- list()
for(i in 1:length(dest.name)){
    # get data
    temp <- 
      readRDS(paste(getwd(), "/output/", "llag.df", ".rds", sep="") )[[dest.name[i]]]$llag.df.x.train 
    
    n <- tuned.lambda[tuned.lambda$destination==dest.name[i], "n"] |> as.numeric()
    if(length(n)==0) next else
      temp <- temp[(nrow(temp)-n+1):nrow(temp),]

    # est
    bm.mod[[dest.name[i]]] <-
      lm(y~ar, data=temp)
}

```



# Forecast
  # Original scale
```{r}
pred <- c()
for (i in 1:length(dest.name)) {
  # create x data
  test.df <- readRDS(paste(getwd(), "/output/",
                      "llag.df", ".rds", sep=""))[[dest.name[i]]]$llag.df.x %>% drop_na()

    n <- tuned.lambda[tuned.lambda$destination==dest.name[i], "n"] |> as.numeric()
    if(length(n)==0) next else
      test.df <- test.df[(nrow(test.df)-n+1):nrow(test.df),]
    
  # Predict glmnet
  for (j in which.lambda) {
      mod <- readRDS(paste(getwd(), "/output/", "final.glmnet.result", dest.name[i], ".rds", sep=""))[[j]]

      if (is.null(mod)) temp <- test.df %>%
          dplyr::select(year.mon, destination) %>%
          mutate(fit=NA) else

      temp <- predict(mod, newdata = test.df) %>% as.tibble() %>%
              dplyr::rename(fit=value) %>%
              mutate(year.mon=test.df$year.mon,
                     destination=test.df$destination)

      temp$which.lambda <- j
      pred <- rbind(pred, temp)
  }

  # Predict benchmark
  mod <- bm.mod[[dest.name[i]]]
  temp <- predict(mod, newdata = test.df) %>% as.tibble() %>%
              dplyr::rename(fit=value) %>%
              mutate(year.mon=test.df$year.mon,
                     destination=test.df$destination)

  temp$which.lambda <- "Benchmark"
  pred <- rbind(pred, temp)
}
pred <- pred %>% left_join(., df.y) %>%
  mutate(dataset=ifelse(year.mon>cutoff.time,"Testing","Training"),
         y=y,fit=fit)

# pred <- pred %>% filter(destination!="POL")

##########################################################################

# compute metric
    ## compare rmse with benchmark
metric <- bind_rows(
  pred %>% group_by(which.lambda, dataset) %>%
  dplyr::summarise(rmse=sqrt(mean((fit-y)^2,na.rm=T ))),
  pred %>% group_by(which.lambda, dataset,destination) %>%
  dplyr::summarise(rmse=sqrt(mean((fit-y)^2,na.rm=T ))) ) %>%  
  mutate(destination=ifelse(is.na(destination), "All.Dest", destination))
  
metric.diff <- metric %>% 
  spread(which.lambda,rmse) %>% 
    mutate(diff=DynENet-Benchmark)

plot.df <- metric.diff %>% mutate(color=ifelse(destination=="All.Dest","1","0"))
plot.df %>% ggplot(aes(x=destination, y=diff))+
  geom_hline(yintercept = 0, color="grey30", linetype="dashed")+
  geom_col(aes(fill=color), position=position_dodge(.5), 
           width=.5, alpha=.8, color="grey20", show.legend = F) +
  theme_bw()+
  theme(plot.margin = ggplot2::margin(t=.5, r=.5, b=.5, l=.5, unit="cm"))+
  ylab(paste("Difference in RMSE (", which.lambda, " - Benchmark)", sep="") )+
  facet_wrap(.~dataset)+
  coord_flip()
ggsave(paste(getwd(), "/output/","metric.jpeg", sep=""), height=6, width=6)
with(plot.df, diff[destination=="All.Dest" & dataset=="Testing"] )

# forecasting conf int. Note: boostrapping using training residuals!
set.seed(123)
boot.times <- 1000
sim.df <- c()
for (i in 1:boot.times) {
  sample.res <- pred %>% filter(dataset=="Training") %>% 
    mutate(res=fit-y) %>% dplyr::select(which.lambda,destination,res) %>% 
    group_by(which.lambda,destination) %>%
      slice_sample(n = testing.periods) %>% dplyr::mutate(rows=row_number())
  temp <- pred %>% filter(dataset=="Testing") %>% 
    group_by(which.lambda,destination) %>% dplyr::mutate(rows=row_number()) %>%
    left_join(.,sample.res) %>% 
    mutate(sim.y=fit+res) 
  sim.df <- bind_rows(sim.df, temp)  
}

conf <- sim.df %>% group_by(which.lambda,destination, year.mon) %>% 
  dplyr::summarise(
    upr=quantile(sim.y, prob=.975,na.rm=T), 
    lwr=quantile(sim.y, prob=.025,na.rm=T) )


#-- plot aggregated trends
plot.df <- bind_rows(
  #for all dest
    pred %>% group_by(year.mon,which.lambda,dataset) %>% 
      dplyr::summarise(fit=sum(exp(fit)*1000,na.rm=T),
                       y=sum(exp(y)*1000,na.rm=T)),
    # for each dest
    pred %>% group_by(year.mon,which.lambda,dataset,destination) %>% 
      dplyr::summarise(fit=sum(exp(fit)*1000,na.rm=T),
                       y=sum(exp(y)*1000,na.rm=T)) %>% 
      filter(destination %in% dest.name) ) %>% 
  mutate(destination=ifelse(is.na(destination), "All.Dest", destination))

temp <- bind_rows(
  #for all dest
  conf %>% group_by(year.mon,which.lambda) %>% 
    dplyr::summarise(upr=sum(exp(upr)*1000,na.rm=T),
                     lwr=sum(exp(lwr)*1000,na.rm=T)),
  # for each dest
  conf %>% group_by(year.mon,which.lambda,destination) %>% 
    dplyr::summarise(upr=sum(exp(upr)*1000,na.rm=T),
                     lwr=sum(exp(lwr)*1000,na.rm=T))
  ) %>%  mutate(destination=ifelse(is.na(destination), "All.Dest", destination))
  
plot.df <- left_join(plot.df,temp)

p.all <- ggplot(plot.df %>% filter(destination=="All.Dest"), 
             aes(x=year.mon))+
  facet_wrap(.~destination, ncol=4, scales="free_y")+ # 
  geom_point(aes(y=y), color="black", shape=1,size=1.5, alpha=.8) +
  geom_line(aes(y=fit, color=which.lambda, linetype=which.lambda),
        linewidth=.8,alpha=0.8) +
  geom_ribbon(aes(ymin=lwr, ymax=upr, fill=which.lambda),
            alpha=0.28) +
  theme_bw() +
  # scale_x_date(labels = date_format("%Y")) +
  geom_vline(xintercept=cutoff.time, color="grey50", linewidth=.8, linetype="dashed") +
  ylab("") + xlab("")+
  theme(legend.position = "none")  

p.dest <- plot.df %>% filter(destination!="All.Dest") %>% 
  left_join(., metric.diff %>% filter(dataset=="Testing") %>% 
              dplyr::select(destination,diff)
            )
p.dest <- p.dest %>% 
  mutate(destination=
           paste( destination, "|", "Test RMSE Diff.", round(diff,3),sep=" "))
p.dest$destination <- reorder(p.dest$destination, p.dest$diff)
p.dest <- ggplot(p.dest %>% filter(destination!="All.Dest"), 
             aes(x=year.mon))+
  facet_wrap(.~destination, ncol=3, #scales="free_y"
             )+ # 
  geom_point(aes(y=y), color="black", shape=1,size=1.5, alpha=.8) +
  geom_line(aes(y=fit, color=which.lambda, linetype=which.lambda),
        linewidth=.8,alpha=0.8) +
  geom_ribbon(aes(ymin=lwr, ymax=upr, fill=which.lambda),
            alpha=0.28) +
  theme_bw() +
  scale_x_date(labels = date_format("%y-%m"), breaks=pretty_breaks()) +
  geom_vline(xintercept=cutoff.time, color="grey50", linewidth=.8, linetype="dashed") +
  ylab("Asyl. Seekers per 1000 Origin Pop.") + xlab("")+
  theme(legend.position = "bottom",
      legend.title = element_blank(),
      axis.text.x=element_text(angle=0))

plot_grid(p.all, p.dest, align="v", ncol=1, axis = "bt", 
          rel_heights=c(2,8))
ggsave(paste(getwd(), "/output/","PredTS.agg.jpeg", sep=""),
       width=8, height=12)



```



# check selected covar
```{r}
selected.x <- coef.result %>% 
  filter(which.lambda==which.lambda) %>% 
  select(destination, vars, coef) %>% rename(Overall=coef) %>% 
  mutate(Overall=abs(Overall)) %>% 
  mutate(vars=gsub("`","",vars))

plot.df <- c()
for (i in 1:length(dest.name)) {
  # create x data
  temp <- readRDS(paste(getwd(), "/output/",
                      "llag.df", ".rds", sep=""))[[dest.name[i]]]$llag.df.x 
  plot.df <- bind_rows(plot.df, temp)
}

output <- c()

###################################################################
  # Drought
what <- "Drought."

if(ncol(plot.df %>% ungroup() %>% dplyr::select(matches(what)))==0) temp <- tibble() else
temp <- plot.df %>%
  dplyr::select(destination, year.mon, matches(what)) %>%
  gather(var, value, -c(destination, year.mon)) %>%
  left_join(., selected.x, by=c("var"="vars", "destination")) %>%
  filter(Overall>0 & !is.na(Overall))

if(nrow(temp)==0) print("No Selected Vars") else
temp <- temp %>% 
  mutate(event=word(var,2,2,sep="-"),
         var.type=word(var,1,1,sep="_")) 

output <- bind_rows(output, temp)

###################################################################
  # gdelt
what <- "gdelt"

if(ncol(plot.df %>% ungroup() %>%  dplyr::select(matches(what)))==0) temp <- tibble() else
temp <- plot.df %>%
  dplyr::select(destination, year.mon, matches(what)) %>%
  gather(var, value, -c(destination, year.mon)) %>%
  left_join(., selected.x, by=c("var"="vars", "destination")) %>%
  filter(Overall>0 & !is.na(Overall))

if(nrow(temp)==0) print("No Selected Vars") else
temp <- temp %>% 
  mutate(event=word(var,3,3,sep="-"),
         var.type=word(var,1,1,sep="_")) 

output <- bind_rows(output, temp)

###################################################################
  # SAVI
what <- "SAVI"

if(ncol(plot.df %>% ungroup() %>%  dplyr::select(matches(what)))==0) temp <- tibble() else
temp <- plot.df %>%
  dplyr::select(destination, year.mon, matches(what)) %>%
  gather(var, value, -c(destination, year.mon)) %>%
  left_join(., selected.x, by=c("var"="vars", "destination")) %>%
  filter(Overall>0 & !is.na(Overall))

if(nrow(temp)==0) print("No Selected Vars") else
temp <- temp %>% 
  mutate(event=word(var,2,2,sep="-"),
         var.type=word(var,1,1,sep="_")) 

output <- bind_rows(output, temp)

###################################################################
  # Soil Moisture index
what <- "Soil"

if(ncol(plot.df %>% ungroup() %>%  dplyr::select(matches(what)))==0) temp <- tibble() else
temp <- plot.df %>%
  dplyr::select(destination, year.mon, matches(what)) %>%
  gather(var, value, -c(destination, year.mon)) %>%
  left_join(., selected.x, by=c("var"="vars", "destination")) %>%
  filter(Overall>0 & !is.na(Overall))

if(nrow(temp)==0) print("No Selected Vars") else
temp <- temp %>% 
  mutate(event=word(var,2,2,sep="-"),
         var.type=word(var,1,1,sep="_")) 

output <- bind_rows(output, temp)


###################################################################
  # SPEI
what <- "SPEI"

if(ncol(plot.df %>% ungroup() %>%  dplyr::select(matches(what)))==0) temp <- tibble() else
temp <- plot.df %>%
  dplyr::select(destination, year.mon, matches(what)) %>%
  gather(var, value, -c(destination, year.mon)) %>%
  left_join(., selected.x, by=c("var"="vars", "destination")) %>%
  filter(Overall>0 & !is.na(Overall))

if(nrow(temp)==0) print("No Selected Vars") else
temp <- temp %>% 
  mutate(event=word(var,2,2,sep="-"),
         var.type=word(var,1,1,sep="_")) 

output <- bind_rows(output, temp)

# ###################################################################
#   # Twitter
# what <- "twitter"
# 
# if(ncol(plot.df %>% ungroup() %>%  dplyr::select(matches(what)))==0) temp <- tibble() else
# temp <- plot.df %>%
#   dplyr::select(destination, year.mon, matches(what)) %>%
#   gather(var, value, -c(destination, year.mon)) %>%
#   left_join(., selected.x, by=c("var"="vars", "destination")) %>%
#   filter(Overall>0 & !is.na(Overall))
# 
# if(nrow(temp)==0) print("No Selected Vars") else
# temp <- temp %>%
#   mutate(event=word(var,2,2,sep="-"))
# 
# output <- bind_rows(output, temp)


###################################################################
output %>% filter(var.type=="v") %>%
  ggplot(aes(x=year.mon, y=value, color=destination, group=var, alpha=Overall) ) +
  geom_line()+
  facet_wrap(.~event, scales = "free_y", ncol=3)+
  theme_minimal() +
  scale_x_date(labels = date_format("%Y-%m"))
ggsave(paste(getwd(), "/output/","v.trend.jpeg", sep=""), height=10, width=10)

output %>% filter(var.type!="v") %>%
  ggplot(aes(x=year.mon, y=value, color=destination, group=var, alpha=Overall) ) +
  geom_line()+
  facet_wrap(.~event, scales = "free_y", ncol=3)+
  theme_minimal() +
  scale_x_date(labels = date_format("%Y-%m"))
ggsave(paste(getwd(), "/output/","cum.trend.jpeg", sep=""), height=10, width=10)


# ###################################################################
#   # spill
# what <- "spill"
# 
# if(ncol(plot.df %>% ungroup() %>%  dplyr::select(matches(what)))==0) temp <- tibble() else
# temp <- plot.df %>%
#   dplyr::select(destination, year.mon, matches(what)) %>%
#   gather(var, value, -c(destination, year.mon)) %>%
#   left_join(., selected.x, by=c("var"="vars", "destination")) %>%
#   filter(Overall>0 & !is.na(Overall))
# 
# if(nrow(temp)==0) print("No Selected Vars") else
# temp <- temp %>% 
#   mutate(event=word(var,2,2,sep="-")) 
# 
# output <- temp
# 
# output %>% 
#   ggplot(aes(x=year.mon, y=value, color=var, group=var, alpha=Overall) ) +
#   geom_line()+
#   facet_wrap(.~destination, scales = "free_y", ncol=3)+
#   theme_minimal() +
#   scale_x_date(labels = date_format("%Y-%m"))
# ggsave(paste(getwd(), "/output/","spill.trend.jpeg", sep=""), height=10, width=10)

```

